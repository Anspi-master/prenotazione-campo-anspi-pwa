// =====================
// 1. COSTANTI E CONFIGURAZIONE
// =====================
const SHEET_ID = "1ENLgTyM15P7HgwFsVQGJxtTI-2mZ4Dorrho9QIa3bEk";
const SHEET_NAME = "Prenotazioni1";
const ADMIN_SHEET_NAME = "AdminUsers";
const ARCHIVE_SHEET_NAME = "Archivio_Prenotazioni";
const ADMIN_EMAIL_RECIPIENT = "prenotazionecampoanspi@gmail.com";
const PASSWORD_SALT_KEY = 'PASSWORD_SALT';
const ADMIN_EMAILS_FOR_NOTIFICATIONS = ['pasqualem27@gmail.com','prenotazionecampoanspi@gmail.com'];


// COSTANTI
const DURATION_MAP = { calcetto: 90, pallavolo: 120, compleanno: 180, eventi: 180 };
const CACHE_DURATION = 300; // 5 minuti
const LOCK_TIMEOUT = 15000; // 15 secondi
const REMINDER_WINDOW = 75; // 75 minuti prima
const OPENING_HOURS = { start: 8, end: 22, lunchStart: 13, lunchEnd: 16 };
const ITALIAN_HOLIDAYS = [
  '01-01', '01-06', '04-25', '05-01', '06-02', '08-15', '11-01', '12-08', '12-25', '12-26'
];

// Costanti per cache - AGGIUNGI DOPO ITALIAN_HOLIDAYS
const CACHE_KEYS = {
  EVENTS: 'events_cache',
  USERS: 'users_cache',
  CONFIG: 'config_cache', 
  BOOKINGS: 'bookings_cache'
};

// Mapping nomi fogli per compatibilitÃ  - AGGIUNGI
const SPREADSHEET_ID = SHEET_ID; // Usa l'ID che hai giÃ 
const SHEET_NAMES = {
  EVENTS: SHEET_NAME,           // "Prenotazioni1"
  USERS: ADMIN_SHEET_NAME,      // "AdminUsers"
  CONFIG: 'Configurazione',     // Nuovo foglio per config
  ARCHIVE: ARCHIVE_SHEET_NAME   // "Archivio_Prenotazioni"
};

// === CONFIGURAZIONE TELEGRAM ===
const TELEGRAM_BOT_TOKEN = '7563290686:AAGBhuoQLXc5SPQ8q1Ck4KB2QvFSZRRjL9M';
const TELEGRAM_CHAT_IDS = [
  '686525181',
  '1619944598', // nuovo admin
];
const TELEGRAM_MASTER_CHAT_ID = '686525181';

// =====================
// ROUTER PRINCIPALE - VERSIONE MIGLIORATA
// =====================

function doGet(e) {
  // âœ… LOG MOLTO VISIBILE - VERIFICA SE IL ROUTER VIENE CHIAMATO
  console.log('ğŸš¨ğŸš¨ğŸš¨ ROUTER doGet CHIAMATO! ğŸš¨ğŸš¨ğŸš¨');
  console.log('ğŸš¨ğŸš¨ğŸš¨ PARAMETRI RICEVUTI:', JSON.stringify(e.parameter));
  console.log('ğŸš¨ğŸš¨ğŸš¨ TIMESTAMP:', new Date().toISOString());
  
  // âœ… DEBUG DETTAGLIATO: Log dei parametri ricevuti
  console.log('ğŸ” === DEBUG doGet ===');
  console.log('ğŸ” doGet chiamato con parametri:', e.parameter);
  console.log('ğŸ” Tipo di e.parameter:', typeof e.parameter);
  console.log('ğŸ” e.parameter Ã¨ null/undefined?', e.parameter === null || e.parameter === undefined);
  console.log('ğŸ” URL completa:', e.parameter ? JSON.stringify(e.parameter) : 'Nessun parametro');
  
  if (e.parameter) {
    console.log('ğŸ” Chiavi in e.parameter:', Object.keys(e.parameter));
    console.log('ğŸ” Numero di parametri:', Object.keys(e.parameter).length);
    
    if (e.parameter.page) {
      console.log('ğŸ” e.parameter.page:', e.parameter.page);
      console.log('ğŸ” Tipo di e.parameter.page:', typeof e.parameter.page);
    }
    
    // Debug di tutti i parametri
    Object.keys(e.parameter).forEach(key => {
      console.log(`ğŸ” Parametro ${key}:`, e.parameter[key], `(tipo: ${typeof e.parameter[key]})`);
    });
  }
  
  // âœ… Gestione piÃ¹ robusta dei parametri
  let route = 'app';
  if (e.parameter && e.parameter.page) {
    route = e.parameter.page;
    console.log('ğŸ›£ï¸ Route impostata da e.parameter.page:', route);
  }
  
  console.log('ğŸ›£ï¸ Route finale:', route);
  console.log('ğŸ›£ï¸ Route === "api":', route === 'api');
  console.log('ğŸ›£ï¸ Route === "app":', route === 'app');
  
  switch(route) {
    case 'api':
      console.log('ğŸŒ Gestendo richiesta API...');
      return handleApiRequest(e, 'GET');
      

      
    default:
      console.log('ğŸ  Route default - controllando reset password...');
      // âœ… CONTROLLO PER RESET PASSWORD (compatibilitÃ )
      if (e.parameter && e.parameter.resetToken) {
        console.log('ğŸ”‘ Reset password richiesto con token:', e.parameter.resetToken);
        return servePasswordResetPage(e.parameter.resetToken);
      }
      
      // âœ… Serve la pagina principale
      console.log('ğŸ  Servendo pagina principale...');
      var template = HtmlService.createTemplateFromFile('index');
      template.queryString = e.parameter || {};
      template.baseUrl = ScriptApp.getService().getUrl();
      
      const mainResult = template.evaluate()
        .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
      console.log('ğŸ  Pagina principale MIME type: text/html (HtmlService)');
      return mainResult;
  }
}

// âœ… Gestione POST separata
function doPost(e) {
  console.log('ğŸ“¤ doPost chiamato con parametri:', e.parameter);
  return handleApiRequest(e, 'POST');
}

// âœ… Gestione API requests
function handleApiRequest(e, method) {
  try {
    const action = e.parameter.action;
    const data = method === 'POST' && e.postData ? JSON.parse(e.postData.contents) : e.parameter;
    const result = serverRequest(action, data);
    
    return ContentService
      .createTextOutput(JSON.stringify(result))
      .setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    console.error('âŒ Errore handleApiRequest:', error);
    return ContentService
      .createTextOutput(JSON.stringify({ status: 'error', message: error.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}









// âœ… Funzione include (se non ce l'hai giÃ )
function include(filename) {
  try {
    console.log(`ğŸ“ Inclusione file: ${filename}`);
    return HtmlService.createHtmlOutputFromFile(filename).getContent();
  } catch (error) {
    console.error(`âŒ Errore inclusione file ${filename}:`, error);
    return `<!-- Errore caricamento ${filename}: ${error.message} -->`;
  }
}

function onOpen() {
  var ui = SpreadsheetApp.getUi();
  ui.createMenu('Gestione Campo')
    .addItem('Test Notifica Telegram', 'testTelegramNotification')
    .addItem('Test Alert Stesso Giorno', 'testSameDayAlert')
    .addItem('Invia Riepilogo Giornaliero', 'sendDailySummaryToAdmin')
    .addItem('Pulisci Cache Riepilogo', 'clearDailySummaryCache')
    .addItem('Setup Notifiche/Trigger', 'setupEventNotifications')
    .addItem('Disattiva Tutti i Trigger', 'disableAllNotificationTriggers')
    .addItem('Test Connessione Fogli', 'testSheetConnection')
    .addItem('Test Sistema Ricorrenze', 'checkAndGenerateRecurringEvents')
    .addItem('Pulisci Cache', 'clearCache')
    .addSeparator()
    .addItem('ğŸ”‘ Reset Password Tutti Admin', 'resetAllAdminPasswords')
    .addItem('ğŸ”‘ Imposta Password Temp Tutti', 'setTempPasswordForAll')
    .addSeparator()

    .addToUi();
}

// =====================
// FUNZIONE serverRequest - AGGIORNATA
// =====================

async function serverRequest(action, data) {
  try {
    // Timeout check
const startTime = new Date().getTime();
const MAX_EXECUTION_TIME = 25000; // 25 secondi

// Controlla periodicamente (metti questo check prima di ogni case pesante)
if (new Date().getTime() - startTime > MAX_EXECUTION_TIME) {
    return { status: 'error', message: 'Timeout esecuzione' };
}
    
    switch (action) {
      // === AZIONI ESISTENTI ===
      case 'checkAndGenerateRecurringEvents': return checkAndGenerateRecurringEvents();
      case 'setupSmartRecurringTrigger': return setupSmartRecurringTrigger();
      case 'getBookings': return { status: 'ok', data: { bookings: getBookings() } };
      case 'getBookingsForCalendar': return { status: 'ok', data: { bookings: getBookingsForCalendar() } };
      case 'manualArchive': return archiveOldBookings();
      case 'testTelegramNotification': return testTelegramNotification();
      case 'testSameDayAlert': return testSameDayAlert();
      case 'sendDailySummaryToAdmin': return sendDailySummaryToAdmin();
      case 'createBooking': return createBooking(data);
      case 'cancelBooking': return cancelBooking(data.bookingId);
      case 'adminLogin': return adminLogin(data); 
      case 'createAdminPassword': return createAdminPassword(data);
      case 'requestPasswordReset': return requestPasswordReset(data);
      case 'performPasswordReset': return performPasswordReset(data);
      case 'deleteBooking': return deleteBooking(data.bookingId);
      case 'updateBookingDetail': return updateBookingDetail(data.bookingId, data.field, data.value);
      case 'updateEventStatus': return updateEventStatus(data);
      case 'getEventStats': return getEventStats();

      case 'getArchivedBookings': return { status: 'ok', data: { bookings: getArchivedBookings() } };
      case 'getArchiveTriggerInfo': return getArchiveTriggerInfo();
      case 'testMarkDailySummary': return testMarkDailySummary();
      case 'markDailySummary': return markDailySummarySent(data.date);
      case 'clearDailySummaryCache': return clearDailySummaryCache();
      case 'getTriggerInfo': return getTriggerInfo();
      case 'setupEventNotifications': return setupEventNotifications();
      case 'disableAllNotificationTriggers': return disableAllNotificationTriggers();

      // === AZIONI GESTIONE ADMIN MASTER ===
      case 'getAllAdmins': return getAllAdmins();
      case 'addNewAdmin': return addNewAdmin(data);
      case 'removeAdmin': return removeAdmin(data);
      case 'resetAdminPassword': return resetAdminPassword(data);
      case 'initializeMissingAdmins': return initializeMissingAdmins();
      case 'testAdminAuth': return testAdminAuth();
      
      // === AZIONI AGGIUNTE ===
      case 'clearCache': return clearCache();
      case 'ping': return { status: 'ok', message: 'pong', timestamp: new Date().toISOString() };
      case 'clearBookingsCache': return clearBookingsCache();
      case 'cleanupDuplicateEvents': return cleanupDuplicateRecurringEvents();
      case 'getCacheStatus': return getCacheStatus();
      

      // Manifest e Service Worker ora gestiti inline nell'HTML
      case 'testSheetConnection': 
  try {
    return testSheetConnection();
  } catch (error) {
    debugLog(`âŒ Errore critico test connessione: ${error.message}`);
    return {
      success: false,
      message: `Test fallito: ${error.message}`
    };
  }

      case 'safeTestConnection': return safeTestConnection();
      case 'testSmartRecurring': 
        try {
          console.log('ğŸ§ª === TEST SISTEMA RICORRENZE ===');
          const result = checkAndGenerateRecurringEvents();
          console.log('âœ… Test completato:', result);
          return result;
        } catch (error) {
          console.error('âŒ Errore test:', error);
          return { status: 'error', message: error.message };
        }
      case 'setupSmartTrigger': return createDailyArchiveTrigger();
      case 'resetSmartSystem': return deleteArchiveTriggers();
      case 'manualRecurringCheck': return checkAndGenerateRecurringEvents();
      case 'cleanupDuplicateRecurringEvents': return cleanupDuplicateRecurringEvents();

      case 'getRecurringEvents': 
        const recurringEvents = getBookings().filter(event => event.ricorrente === 'sÃ¬' || event.ricorrente === true);
        return { status: 'ok', data: { events: recurringEvents } };
      case 'getDebugInfo':
        try {
          console.log('ğŸ” === DEBUG INFO ===');
          const sheet = getSheet();
          const data = sheet.getDataRange().getValues();
          const recurringEvents = data.filter((row, index) => index > 0 && row[headers.indexOf('ricorrente')] === true);
          
          return {
            status: 'ok',
            data: {
              spreadsheetId: SHEET_ID,
              sheetNames: {
                events: SHEET_NAME,
                admin: ADMIN_SHEET_NAME,
                archive: ARCHIVE_SHEET_NAME
              },
              timestamp: new Date().toISOString(),
              totalRows: data.length,
              recurringEventsCount: recurringEvents.length,
              cacheStatus: getCacheStatus(),
              triggerStatus: getSimpleTriggerStatus()
            }
          };
        } catch (error) {
          console.error('âŒ Errore debug info:', error);
          return { status: 'error', message: error.message };
        }
      
      default: 
        throw new Error(`Azione non riconosciuta: ${action}`);
    }
  } catch (error) {
    debugLog(error);
    return { status: 'error', message: error.message };
  }
}

function getAdminSheet() {
  try {
    console.log('ğŸ”§ getAdminSheet() - SHEET_ID:', SHEET_ID);
    console.log('ğŸ”§ getAdminSheet() - ADMIN_SHEET_NAME:', ADMIN_SHEET_NAME);
    
  const ss = SpreadsheetApp.openById(SHEET_ID);
    console.log('ğŸ”§ getAdminSheet() - Spreadsheet aperto:', ss.getName());
    
  const sheet = ss.getSheetByName(ADMIN_SHEET_NAME);
    console.log('ğŸ”§ getAdminSheet() - Foglio AdminUsers trovato:', sheet ? 'SÃ¬' : 'No');
    
    if (!sheet) {
      console.log('âŒ getAdminSheet() - Fogli disponibili:', ss.getSheets().map(s => s.getName()));
      throw new Error(`Foglio amministratori "${ADMIN_SHEET_NAME}" non trovato.`);
    }
    
    console.log('âœ… getAdminSheet() - Foglio AdminUsers restituito correttamente');
  return sheet;
  } catch (error) {
    console.error('âŒ getAdminSheet() - Errore:', error.message);
    throw error;
  }
}

// =====================
// FUNZIONI GESTIONE TRIGGER - PRODUZIONE
// =====================

/**
 * Ottiene informazioni sui trigger attivi
 */
function getTriggerInfo() {
  try {
    const triggers = ScriptApp.getProjectTriggers();
    const relevantTriggers = triggers.filter(trigger => 
      trigger.getHandlerFunction() === 'checkAndGenerateRecurringEvents' ||
      trigger.getHandlerFunction() === 'sendDailySummaryToAdmin' ||
      trigger.getHandlerFunction() === 'checkUpcomingEventsAndNotify'
    );
    
    return {
      status: 'ok',
      active: relevantTriggers.length > 0,
      count: relevantTriggers.length,
      message: `${relevantTriggers.length} trigger attivi`,
      triggers: relevantTriggers.map(t => ({
        function: t.getHandlerFunction(),
        type: t.getEventType(),
        source: t.getTriggerSource()
      }))
    };
  } catch (error) {
    debugLog(`âŒ Errore getTriggerInfo: ${error.message}`);
    return {
      status: 'error',
      active: false,
      count: 0,
      message: error.message
    };
  }
}

/**
 * Crea il trigger giornaliero consolidato
 */
function deleteArchiveTriggers() {
  try {
    const triggers = ScriptApp.getProjectTriggers();
    let deletedCount = 0;
    
    // ELIMINA TUTTI i trigger del sistema (anche duplicati)
    triggers.forEach(trigger => {
      const fn = trigger.getHandlerFunction();
      if (fn === 'sendDailySummaryToAdmin' || 
          fn === 'checkUpcomingEventsAndNotify' ||
          fn === 'checkAndGenerateRecurringEvents') {
        try {
          ScriptApp.deleteTrigger(trigger);
          deletedCount++;
          console.log(`ğŸ—‘ï¸ Eliminato: ${fn}`);
        } catch (e) {
          console.log(`âš ï¸ Errore eliminazione: ${e}`);
        }
      }
    });
    
    console.log(`âœ… Eliminati ${deletedCount} trigger totali`);
    return { status: 'ok', deletedCount: deletedCount };
  } catch (error) {
    return { status: 'error', message: error.message };
  }
}

function createDailyArchiveTrigger() {
  try {
    // PRIMA: Pulisci TUTTI i trigger esistenti
    const deleteResult = deleteArchiveTriggers();
    console.log(`ğŸ§¹ Pulizia completata: ${deleteResult.deletedCount} trigger rimossi`);
    
    // DOPO: Crea UN SOLO set pulito
    ScriptApp.newTrigger('checkAndGenerateRecurringEvents')
      .timeBased()
      .everyDays(1)
      .atHour(0)
      .create();
    
    console.log('âœ… Creato nuovo trigger unificato');
    return { status: 'ok', message: 'Sistema ricreato con trigger puliti' };
  } catch (error) {
    return { status: 'error', message: error.message };
  }
}

// âœ… FUNZIONE DI TEST AUTORIZZAZIONE ADMIN
function testAdminAuth() {
  try {
    console.log('ğŸ§ª Test autorizzazione admin iniziato...');
    
    // Test 1: Verifica foglio AdminUsers
    const adminSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('AdminUsers');
    if (!adminSheet) {
      console.log('âŒ Foglio AdminUsers non trovato!');
      return ContentService.createTextOutput(JSON.stringify({
        success: false,
        error: 'Foglio AdminUsers non trovato'
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    console.log('âœ… Foglio AdminUsers trovato');
    
    // Test 2: Leggi tutti i dati
    const dataRange = adminSheet.getDataRange().getValues();
    console.log('ğŸ“Š Righe trovate:', dataRange.length);
    
    if (dataRange.length < 2) {
      console.log('âŒ Nessun admin nel foglio!');
      return ContentService.createTextOutput(JSON.stringify({
        success: false,
        error: 'Nessun admin nel foglio',
        rows: dataRange.length
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    // Test 3: Verifica headers
    const headers = dataRange[0].map(h => h.toString().toLowerCase());
    console.log('ğŸ“‹ Headers:', headers);
    
    const emailCol = headers.indexOf('email');
    if (emailCol === -1) {
      console.log('âŒ Colonna email non trovata!');
      return ContentService.createTextOutput(JSON.stringify({
        success: false,
        error: 'Colonna email non trovata',
        headers: headers
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    console.log('âœ… Colonna email trovata alla posizione:', emailCol);
    
    // Test 4: Cerca email specifiche
    const testEmails = [
      'pasqualem27@gmail.com',
      'prenotazionecampoanspi@gmail.com'
    ];
    
    const foundAdmins = [];
    
    for (let i = 1; i < dataRange.length; i++) {
      const rowEmail = dataRange[i][emailCol];
      if (rowEmail) {
        const cleanEmail = rowEmail.toString().toLowerCase().trim();
        console.log(`ğŸ“§ Riga ${i}: "${cleanEmail}"`);
        
        if (testEmails.includes(cleanEmail)) {
          foundAdmins.push({
            row: i,
            email: cleanEmail,
            fullRow: dataRange[i]
          });
        }
      }
    }
    
    console.log('ğŸ” Admin trovati:', foundAdmins.length);
    
    // Test 5: Verifica funzione findAdminByEmail
    const testResult = findAdminByEmail('pasqualem27@gmail.com');
    console.log('ğŸ”§ Risultato findAdminByEmail:', testResult);
    
    return ContentService.createTextOutput(JSON.stringify({
      success: true,
      message: 'Test completato',
      data: {
        totalRows: dataRange.length,
        headers: headers,
        emailColumn: emailCol,
        foundAdmins: foundAdmins,
        findAdminByEmailResult: testResult,
        allEmails: dataRange.slice(1).map(row => row[emailCol]).filter(email => email)
      }
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    console.error('âŒ Errore nel test:', error);
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      error: error.toString(),
      stack: error.stack
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

// âœ… FUNZIONE DI TEST AUTORIZZAZIONE ADMIN - ESECUZIONE DIRETTA
function testAdminAuthDirect() {
  try {
    console.log('ğŸ§ª Test autorizzazione admin iniziato...');
    
    // Test 1: Verifica foglio AdminUsers
    const adminSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('AdminUsers');
    if (!adminSheet) {
      console.log('âŒ Foglio AdminUsers non trovato!');
      return;
    }
    
    console.log('âœ… Foglio AdminUsers trovato');
    
    // Test 2: Leggi tutti i dati
    const dataRange = adminSheet.getDataRange().getValues();
    console.log('ğŸ“Š Righe trovate:', dataRange.length);
    
    if (dataRange.length < 2) {
      console.log('âŒ Nessun admin nel foglio!');
      return;
    }
    
    // Test 3: Controlla headers
    const headers = dataRange[0].map(h => h.toString().toLowerCase().trim());
    console.log('ğŸ“‹ Headers:', headers);
    
    const emailCol = headers.indexOf('email');
    if (emailCol === -1) {
      console.log('âŒ Colonna email non trovata!');
      return;
    }
    
    console.log('âœ… Colonna email trovata alla posizione:', emailCol);
    
    // Test 4: Cerca le email specifiche
    const targetEmails = ['pasqualem27@gmail.com', 'prenotazionecampoanspi@gmail.com'];
    let foundCount = 0;
    
    for (let i = 1; i < dataRange.length; i++) {
      const email = dataRange[i][emailCol];
      if (email) {
        console.log(`ğŸ“§ Riga ${i}: "${email}"`);
        
        if (targetEmails.includes(email.toString().toLowerCase().trim())) {
          foundCount++;
          console.log(`âœ… Email trovata: ${email}`);
        }
      }
    }
    
    console.log(`ğŸ” Admin trovati: ${foundCount}`);
    
    // Test 5: Testa la funzione findAdminByEmail
    console.log('ğŸ”§ Testando findAdminByEmail...');
    const testResult = findAdminByEmail('pasqualem27@gmail.com');
    console.log('ğŸ”§ Risultato findAdminByEmail:', testResult);
    
    // Test 6: Verifica SHEET_ID
    console.log('ğŸ”§ SHEET_ID configurato:', typeof SHEET_ID !== 'undefined' ? 'SÃ¬' : 'No');
    if (typeof SHEET_ID !== 'undefined') {
      console.log('ğŸ”§ SHEET_ID valore:', SHEET_ID);
    }
    
    // Test 7: Verifica getAdminSheet
    try {
      const adminSheetTest = getAdminSheet();
      console.log('âœ… getAdminSheet() funziona');
      console.log('ğŸ”§ Nome foglio getAdminSheet:', adminSheetTest.getName());
    } catch (error) {
      console.log('âŒ getAdminSheet() errore:', error.message);
    }
    
    console.log('âœ… Test completato!');
    
  } catch (error) {
    console.error('âŒ Errore durante il test:', error);
  }
}

// âœ… FUNZIONE: Reset password per TUTTI gli amministratori
function resetAllAdminPasswords() {
  try {
    console.log('ğŸ”§ Reset password per TUTTI gli amministratori...');
    
    const adminSheet = getAdminSheet();
    const data = adminSheet.getDataRange().getValues();
    const headers = data[0].map(h => h.toLowerCase());
    const emailCol = headers.indexOf('email');
    const passwordHashCol = headers.indexOf('passwordhash');
    
    let resetCount = 0;
    const resetEmails = [];
    
    // Reset password per tutti gli admin
    for (let i = 1; i < data.length; i++) {
      if (data[i][emailCol]) {
        const email = data[i][emailCol].toString().toLowerCase().trim();
        
        // Pulisci la password hash (primo accesso)
        adminSheet.getRange(i + 1, passwordHashCol + 1).setValue('');
        resetCount++;
        resetEmails.push(email);
        
        console.log(`âœ… Password resettata per: ${email}`);
      }
    }
    
    console.log(`âœ… Reset completato! ${resetCount} amministratori resettati:`);
    resetEmails.forEach(email => console.log(`   - ${email}`));
    
    return {
      status: 'ok',
      message: `Reset completato! ${resetCount} amministratori resettati per primo accesso.`,
      resetCount: resetCount,
      emails: resetEmails
    };
    
  } catch (error) {
    console.error('âŒ Errore reset password:', error);
    return {
      status: 'error',
      message: 'Errore: ' + error.message
    };
  }
}

// âœ… FUNZIONE: Imposta password temporanea per TUTTI gli amministratori
function setTempPasswordForAll() {
  try {
    console.log('ğŸ”§ Imposta password temporanea per TUTTI gli amministratori...');
    
    const adminSheet = getAdminSheet();
    const data = adminSheet.getDataRange().getValues();
    const headers = data[0].map(h => h.toLowerCase());
    const emailCol = headers.indexOf('email');
    const passwordHashCol = headers.indexOf('passwordhash');
    
    let setCount = 0;
    const setEmails = [];
    const tempPassword = '123456'; // Password temporanea per tutti
    
    // Imposta password temporanea per tutti gli admin
    for (let i = 1; i < data.length; i++) {
      if (data[i][emailCol]) {
        const email = data[i][emailCol].toString().toLowerCase().trim();
        
        // Imposta password temporanea
        const tempPasswordHash = hashPassword(tempPassword);
        adminSheet.getRange(i + 1, passwordHashCol + 1).setValue(tempPasswordHash);
        setCount++;
        setEmails.push(email);
        
        console.log(`âœ… Password temporanea impostata per: ${email}`);
      }
    }
    
    console.log(`âœ… Password temporanea impostata! ${setCount} amministratori aggiornati:`);
    setEmails.forEach(email => console.log(`   - ${email}`));
    console.log(`ğŸ”‘ Password temporanea per tutti: ${tempPassword}`);
    
    return {
      status: 'ok',
      message: `Password temporanea impostata! ${setCount} amministratori aggiornati. Password: ${tempPassword}`,
      setCount: setCount,
      emails: setEmails,
      tempPassword: tempPassword
    };
    
  } catch (error) {
    console.error('âŒ Errore set password temporanea:', error);
    return {
      status: 'error',
      message: 'Errore: ' + error.message
    };
  }
}

// âœ… Funzione per servire la pagina di reset password (template separato)
function servePasswordResetPage(token) {
  try {
    var template = HtmlService.createTemplateFromFile('reset_password');
    template.token = token;
    template.baseUrl = ScriptApp.getService().getUrl();
    return template.evaluate();
  } catch (error) {
    console.error('âŒ Errore servePasswordResetPage:', error);
    return HtmlService.createHtmlOutput('<p>Errore reset password</p>');
  }
}

// (Rimossi: test PWA e riferimenti a manifest/service worker)
